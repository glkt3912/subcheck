name: Security & License Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®šæœŸå®Ÿè¡Œ
    - cron: "0 3 * * 1"
  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  vulnerability-scan:
    runs-on: ubuntu-latest
    name: Vulnerability Scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level=moderate --json > audit-report.json

          # è„†å¼±æ€§ã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          HIGH_VULNS=$(cat audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length')
          CRITICAL_VULNS=$(cat audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length')

          echo "Critical vulnerabilities: $CRITICAL_VULNS"
          echo "High vulnerabilities: $HIGH_VULNS"

          # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ•ã‚§ã‚¤ãƒ«
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found"
            cat audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical"))'
            exit 1
          fi

          # é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ãŒ5å€‹ä»¥ä¸Šã®å ´åˆã¯ãƒ•ã‚§ã‚¤ãƒ«  
          if [ "$HIGH_VULNS" -gt 5 ]; then
            echo "âŒ Too many high-risk vulnerabilities ($HIGH_VULNS > 5)"
            exit 1
          fi

          echo "âœ… Vulnerability check passed"

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  # BSL-1.1ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
  license-compliance:
    runs-on: ubuntu-latest
    name: License Compliance Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install license checker
        run: npm install -g license-checker

      - name: Verify BSL-1.1 license
        run: |
          echo "ðŸ” Verifying BSL-1.1 license compliance..."

          # package.jsonã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª
          LICENSE=$(cat package.json | jq -r '.license')
          if [ "$LICENSE" != "BSL-1.1" ]; then
            echo "âŒ Invalid license in package.json: $LICENSE (expected: BSL-1.1)"
            exit 1
          fi

          # LICENSEãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "LICENSE" ]; then
            echo "âŒ LICENSE file not found"
            exit 1
          fi

          # NOTICEãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "NOTICE" ]; then
            echo "âŒ NOTICE file not found"
            exit 1
          fi

          # BSL-1.1ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
          if ! grep -q "Business Source License 1.1" LICENSE; then
            echo "âŒ LICENSE file does not contain BSL-1.1 text"
            exit 1
          fi

          echo "âœ… BSL-1.1 license compliance verified"

      - name: Check dependency licenses
        run: |
          echo "ðŸ” Checking dependency licenses..."

          # å•é¡Œã®ã‚ã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒªã‚¹ãƒˆ
          FORBIDDEN_LICENSES=("GPL" "AGPL" "LGPL-3.0" "SSPL")

          license-checker --json > license-report.json

          # ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
          for license in "${FORBIDDEN_LICENSES[@]}"; do
            if grep -q "$license" license-report.json; then
              echo "âŒ Forbidden license detected: $license"
              grep -A 5 -B 5 "$license" license-report.json
              exit 1
            fi
          done

          echo "âœ… Dependency license check passed"

      - name: Generate license report
        run: |
          license-checker --summary > license-summary.txt
          echo "ðŸ“‹ License summary generated"
          cat license-summary.txt

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            license-report.json
            license-summary.txt
          retention-days: 90

  # å•†ç”¨åˆ©ç”¨æ¤œå‡º
  commercial-usage-check:
    runs-on: ubuntu-latest
    name: Commercial Usage Detection

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for commercial indicators
        run: |
          echo "ðŸ” Checking for commercial usage indicators..."

          # ç’°å¢ƒå¤‰æ•°ã§ã®å•†ç”¨åˆ©ç”¨è¨­å®šãƒã‚§ãƒƒã‚¯
          if grep -r "NEXT_PUBLIC_COMMERCIAL_SERVICE.*true" . --include="*.yml" --include="*.yaml" --include="*.json"; then
            echo "âš ï¸  Commercial service flag detected in configuration"
            
            # å•†ç”¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ãƒ©ã‚°ã‚‚ãƒã‚§ãƒƒã‚¯
            if ! grep -r "NEXT_PUBLIC_COMMERCIAL_LICENSE.*true" . --include="*.yml" --include="*.yaml" --include="*.json"; then
              echo "âŒ Commercial service enabled without commercial license"
              exit 1
            else
              echo "âœ… Commercial license properly configured"
            fi
          else
            echo "âœ… No commercial usage flags detected"
          fi

      - name: Verify license enforcement code
        run: |
          echo "ðŸ” Verifying license enforcement implementation..."

          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚¨ãƒ³ãƒ•ã‚©ãƒ¼ã‚¹ãƒ¡ãƒ³ãƒˆé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "src/utils/licenseNotice.ts" ]; then
            echo "âŒ License enforcement module not found"
            exit 1
          fi

          # é‡è¦ãªé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          if ! grep -q "checkLicenseCompliance" src/utils/licenseNotice.ts; then
            echo "âŒ License compliance check function not found"
            exit 1
          fi

          if ! grep -q "displayLicenseNotice" src/utils/licenseNotice.ts; then
            echo "âŒ License notice display function not found"
            exit 1
          fi

          echo "âœ… License enforcement code verified"

  # ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  code-security:
    runs-on: ubuntu-latest
    name: Code Security Scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install security tools
        run: |
          npm install -g eslint-plugin-security

      - name: Scan for security issues
        run: |
          echo "ðŸ” Scanning code for security issues..."

          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç§˜å¯†æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
          SECRETS_PATTERNS=(
            "password"
            "secret"
            "token"
            "api.*key"
            "private.*key"
          )

          for pattern in "${SECRETS_PATTERNS[@]}"; do
            if grep -ri "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | grep -v ".git"; then
              echo "âš ï¸  Potential secret detected: $pattern"
              # å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚ˆã‚ŠåŽ³å¯†ãªãƒã‚§ãƒƒã‚¯ãŒå¿…è¦
            fi
          done

      - name: Check for unsafe dependencies
        run: |
          echo "ðŸ” Checking for known unsafe packages..."

          # æ—¢çŸ¥ã®å±é™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼‰
          UNSAFE_PACKAGES=("flatmap-stream" "event-stream" "eslint-scope")

          for package in "${UNSAFE_PACKAGES[@]}"; do
            if grep -q "$package" package.json; then
              echo "âŒ Unsafe package detected: $package"
              exit 1
            fi
          done

          echo "âœ… No unsafe packages detected"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  security-report:
    runs-on: ubuntu-latest
    name: Security Report
    needs:
      [
        vulnerability-scan,
        license-compliance,
        commercial-usage-check,
        code-security,
      ]
    if: always()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: Generate security summary
        run: |
          mkdir -p reports

          cat > reports/security-summary.md << 'EOF'
          # Security & License Report

          Generated: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}

          ## Security Checks Status

          - **Vulnerability Scan**: ${{ needs.vulnerability-scan.result }}
          - **License Compliance**: ${{ needs.license-compliance.result }}
          - **Commercial Usage Check**: ${{ needs.commercial-usage-check.result }}
          - **Code Security**: ${{ needs.code-security.result }}

          ## BSL-1.1 License Status

          âœ… Business Source License 1.1 properly configured
          âœ… License enforcement code in place
          âœ… Commercial usage restrictions active

          ## Next Steps

          - Review any failed security checks
          - Update vulnerable dependencies if found
          - Monitor license compliance regularly
          - Ensure commercial license obtained before commercial use

          ## Contact

          - Security issues: security@subcheck.app
          - License questions: licensing@subcheck.app

          EOF

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-report
          path: reports/
          retention-days: 90

      - name: Notify security team
        if: failure()
        run: |
          echo "ðŸš¨ Security check failed!"
          echo "Please review the security report and take immediate action."
          echo "Contact: security@subcheck.app"
